# MIA训练曲线图生成说明

## 文件信息

- **生成脚本**: `generate_mia_training_curves.py`
- **输出文件**:
  - `mia_training_curves.pdf` (56KB) - 用于论文插图
  - `mia_training_curves.eps` (170KB) - LaTeX兼容格式

## 图像说明

该图展示了基于换脸先验的模型反演攻击(MIA)方法的渐进式三阶段训练过程,包含6个子图:

### (a) 总损失与主要分项损失
- 黑色粗线: 总损失(所有损失项的加权和)
- 蓝色: 扩散先验损失 $\mathcal{L}_{prior}$
- 红色: 分类引导损失 $\mathcal{L}_{cls}$
- 显示三个阶段的背景色区分

### (b) 分项损失演化
展示所有5个损失组件的演化:
- $\mathcal{L}_{prior}$: 扩散先验损失
- $\mathcal{L}_{cls}$: Top-k最大间隔分类损失
- $\mathcal{L}_{id}$: 身份一致性对比损失
- $\mathcal{L}_{perc}$: LPIPS感知质量损失
- $\mathcal{L}_{p-reg}$: 特征中心正则化损失

### (c) 攻击准确率
- Acc1: Top-1攻击准确率 (从~0%提升至>90%)
- Acc5: Top-5攻击准确率 (更快饱和至>98%)

### (d) 生成质量指标
- FID (Fréchet Inception Distance): 从高值逐步下降
- KNN Distance: 特征空间距离(右纵轴)

### (e) 任务不确定性权重
展示多任务学习中各损失项的不确定性权重 $1/\sigma_i^2$:
- 初期权重较低且波动
- 随训练逐步学习优化重要性
- 不同任务呈现不同的权重演化模式

### (f) 混合条件余弦退火调度
- 紫色曲线: 混合系数 $\lambda(t) = 0.5(1 - \cos(\pi t/T_{anneal}))$
- 阶段1: $\lambda=0$ (纯图像条件)
- 阶段2: $\lambda: 0\to1$ (平滑过渡)
- 阶段3: $\lambda=1$ (纯标签条件)

## 三阶段训练策略

### 阶段1: 图像条件预热 (Epoch 1-30)
- **目标**: 学习换脸能力
- **输入**: 真实图像的身份嵌入 $e_{id} = E_{id}(x_{real})$
- **优化参数**: LoRA参数 $\{A_\ell, B_\ell\}$
- **损失函数**: $\mathcal{L} = \mathcal{L}_{prior} + \mathcal{L}_{perc}$

### 阶段2: 混合条件过渡 (Epoch 31-80)
- **目标**: 平滑模态迁移
- **输入**: 混合嵌入 $e_{id}(t) = (1-\lambda(t)) E_{id}(x_{real}) + \lambda(t) \mathcal{E}_\psi(y)$
- **优化参数**: LoRA + 标签嵌入层 $\psi$ + 不确定性权重 $\{\sigma_i\}$
- **损失函数**: 基础损失 + $\lambda(t)$ × 攻击损失(任务不确定性加权)

### 阶段3: 纯标签条件适配 (Epoch 81-150)
- **目标**: 最终分类器攻击优化
- **输入**: 纯标签嵌入 $e_{id} = \mathcal{E}_\psi(y)$
- **优化参数**: 所有可训练参数
- **损失函数**: 完整多目标损失 $\mathcal{L}_{total} = \sum_i \frac{\mathcal{L}_i}{2\sigma_i^2} + \frac{\log\sigma_i^2}{2}$

## 关键观察

1. **损失演化**:
   - Prior损失快速下降后稳定
   - 分类损失在阶段2开始激活,阶段3快速优化
   - 身份损失随模态迁移逐步优化

2. **准确率提升**:
   - 阶段1无攻击能力(使用真实图像)
   - 阶段2开始出现攻击成功率(~20-60%)
   - 阶段3达到最佳性能(>90%)

3. **质量指标**:
   - FID从初始80+下降至20左右
   - KNN距离持续优化,表明生成图像接近真实分布

4. **权重学习**:
   - Prior权重较稳定(基础能力)
   - 分类和身份权重随训练增加(攻击能力)
   - 感知质量权重保持平衡(视觉真实性)

5. **退火调度**:
   - 余弦曲线提供平滑过渡
   - 避免突然模态切换导致的训练崩溃
   - 中间阶段学习关键的跨模态映射

## 技术细节

- **总训练轮数**: 150 epochs
- **阶段划分**: 30/50/70 epochs
- **随机种子**: 42 (可重现)
- **图像分辨率**: 18×10英寸, 300 DPI
- **输出格式**: PDF (矢量) + EPS (LaTeX兼容)

## 使用方法

```bash
cd /home/yl/workspace/hithesis/examples/hitbook/chinese/figures
python3 generate_mia_training_curves.py
```

## 注意事项

1. **中文字体警告**: Linux系统缺少SimHei字体会产生警告,但不影响PDF生成
2. **LaTeX插入**: 使用`\includegraphics{figures/mia_training_curves.pdf}`
3. **图注要点**: 需说明三阶段划分、损失组件、评估指标含义
4. **数据来源**: 这是基于方法原理的模拟数据,实际数值需替换为真实实验结果

## 对应章节

- **第四章 §4.4**: 渐进式训练策略(方法描述)
- **第五章 §5.4.1**: MIA训练过程分析(实验结果)
- **第五章 图5.X**: 插入位置(需更新图号)
