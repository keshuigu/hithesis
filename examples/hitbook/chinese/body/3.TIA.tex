% !Mode:: "TeX:UTF-8"

% TODO (写作提示):
% - 在方法开头形式化输入/输出：明确 $x$ (图像) 的尺寸、特征模板 $t$ 的维度、y 的含义等。
% - 在训练/推理小节后增加超参数表（batch size、lr、迭代次数、lambda 调度、随机种子）。
% - 在推理流程图下方给出示例推理命令（便于复现），例如：\texttt{python infer.py --ckpt model.pt --template tpl.npy --steps 18}
% - 若有关键实现文件或脚本，补充路径或仓库链接。

\chapter[面向人脸特征提取模型的逆向重建方法]{面向人脸特征提取模型的逆向重建方法}[Reconstruction Method for Face Feature Extraction Models]\label{chap:TIA}
\section{引言}[Introduction]

本章针对第\ref{sec:background}节所述的基于模板匹配的人脸识别系统，系统研究将已泄露或可获取的特征模板逆向重建为可感知人脸图像的技术方法。根据第\ref{sec:thesis_structure}节对模板逆向重建攻击（Template Inversion Attack, TIA）的定义，本章在明确的威胁模型与形式化任务框架基础上，提出一种基于明晰扩散模型（Elucidating Diffusion Models, EDM）的高保真重建方法。

该方法的核心思想是将扩散模型的强大生成能力与人脸识别的特征匹配目标深度融合，通过设计兼顾像素空间视觉保真度与特征空间识别一致性的混合目标函数，实现两者的协同优化。为解决计算资源受限条件下的高效训练问题，本章采用条件引导、动态权重平衡与采样优化等工程策略，在有限资源下仍获得高质量重建与攻击成功率。此外，本章建立了统一的多维度评估协议，从识别一致性、视觉质量与攻击成功率等角度全面衡量方法性能，为实验验证与对比分析奠定基础。

\section{形式化问题定义}[Problem Formulation]

根据第\ref{chap:theory}章建立的人脸识别系统框架，简要回顾TIA的形式化定义。令人脸识别器为 $F:\mathcal{X}\to\mathbb{R}^d$，将输入图像 $x\in\mathcal{X}\subseteq\mathbb{R}^{H\times W\times C}$ 映射为 $d$ 维特征向量。给定目标模板 $t\in\mathbb{R}^d$，攻击者的目标是重构图像 $\hat{x}$ 使得：
\begin{equation}\label{eq:tia_goal}
  \mathrm{sim}(F(\hat{x}), t) \geq \tau \quad \text{且} \quad \hat{x} \in \mathcal{M}_{\text{natural}},
\end{equation}
其中 $\mathrm{sim}(\cdot,\cdot)$ 为余弦相似度，$\tau$ 为系统的验证阈值，$\mathcal{M}_{\text{natural}}$ 表示自然人脸图像分布。攻击成功判据包括：（1）强成功：满足式\eqref{eq:tia_goal}，图像能直接通过身份验证；（2）弱成功：虽未达到 $\tau$ 但显著高于随机基线，泄露部分生物特征信息；（3）视觉质量：重构图像具有合理人脸特征与自然外观。详见第\ref{sec:thesis_structure}节的完整讨论。

\section{基于明晰扩散模型的模板逆向重建方法}[Method Architecture Based on Elucidating Diffusion Models]
\label{sec:tia_architecture}

本章提出一种基于明晰扩散模型（Elucidating Diffusion Models, EDM）的模板逆向重建方法。该方法的核心创新在于将扩散模型的强大生成能力与人脸识别的特征匹配目标相结合，通过设计混合损失函数和条件引导机制，实现从特征模板到高质量人脸图像的逆向重建。相比基于优化的方法，扩散模型具有训练稳定、模式崩塌风险低、生成质量高等优势，在图像生成、图像修复等任务中展现出优异性能。明晰扩散模型进一步通过重新参数化噪声调度与优化采样策略，提升了生成质量和采样效率。

方法的整体框架包括两个关键阶段：

（1）特征引导的训练阶段：在标准扩散模型的去噪目标基础上，增加特征空间的感知损失，使模型在重建图像的同时保持与原始图像在特征空间中的一致性。通过动态调整损失权重，在训练过程中逐步增强特征约束的作用。（2）模板条件的推理阶段：给定目标模板，从随机噪声出发，通过条件引导的迭代去噪过程生成与模板匹配的人脸图像。在采样过程中引入梯度引导机制，动态调整生成轨迹以增强特征一致性。

图\ref{fig:edm_tia_train}展示了训练阶段的整体流程,该流程将像素空间重建与特征空间匹配有机结合,为后续的模板逆向攻击奠定了基础。

\begin{figure}[!htbp]
  \centering
  \includegraphics[width=0.7\textwidth]{../figures/golfer.eps}
  \caption{基于EDM的模板逆向攻击模型训练流程示意图}
  \label{fig:edm_tia_train}
\end{figure}

\section{混合损失函数设计与三层递进改进}[Hybrid Loss Function Design and Progressive Improvements]
\label{sec:tia_loss}

损失函数的设计是影响模型性能的关键因素。本节在现有混合损失函数的基础上，提出三个递进式的改进方案（方案 A、B、C），通过引入角度约束、多任务学习框架与一致性正则化，逐步提升模型的特征匹配精度和生成质量。

\subsection{基础设计：像素与特征混合损失}

基础框架采用像素空间重建与特征空间约束的混合：
\begin{equation}\label{eq:tia_total_loss_basic}
    \mathcal{L}(\theta) = \mathcal{L}_{\text{pixel}}(\theta) + \lambda(t) \cdot \mathcal{L}_{\text{feat}}(\theta).
\end{equation}

\subsubsection{像素空间重建损失}

像素空间的重建损失采用EDM的标准去噪目标：
\begin{equation}\label{eq:tia_pixel_loss}
  \mathcal{L}_{\text{pixel}}(\theta) = \mathbb{E}_{x_0, \sigma, \epsilon} \left[ w(\sigma) \left\| f_\theta(x_0 + \sigma \epsilon, y, \sigma) - x_0 \right\|^2 \right],
\end{equation}
其中权重函数为 $w(\sigma) = \frac{1}{\sigma^2 + \sigma_{\text{data}}^2}$，使得模型在不同噪声水平下都能得到均衡训练。

\subsubsection{特征空间感知损失（基础版）}

基础特征损失使用欧氏距离约束：
\begin{equation}\label{eq:tia_feat_loss_basic}
  \mathcal{L}_{\text{feat}}(\theta) = \mathbb{E}_{x_0, \sigma, \epsilon} \left[ \left\| F\left( f_\theta(x_0 + \sigma \epsilon, y, \sigma) \right) - F(x_0) \right\|^2 \right].
\end{equation}

\subsubsection{基础动态权重调整}

基础权重调度采用线性增长策略：
\begin{equation}\label{eq:tia_lambda_basic}
  \lambda(t) = \begin{cases}
    0, & t < t_{\text{warmup}} \\
    \lambda_{\max} \cdot \frac{t - t_{\text{warmup}}}{t_{\text{total}} - t_{\text{warmup}}}, & t_{\text{warmup}} \le t \le t_{\text{total}} \\
    \lambda_{\max}, & t > t_{\text{total}}
  \end{cases}
\end{equation}

**基础设计的局限性**：
- L2 范数未充分利用特征空间的超球面几何结构
- 线性权重调度在 $t_{\text{warmup}}$ 处存在尖锐跳变
- 缺乏对困难样本的重点关注
- 未与现代人脸识别系统（如 ArcFace）的设计思想对齐

---

\subsection{方案 A：基于角度空间的特征匹配（★ 核心创新）}
\label{subsec:tia_scheme_a}

**核心创新**：在特征空间引入角度约束机制，与 ArcFace 的单位超球面几何对齐。

\subsubsection{角度约束特征损失}

将欧氏距离替换为角度空间的对比约束：
\begin{equation}\label{eq:tia_angle_loss}
    \mathcal{L}_{\text{feat}}^{(\text{A})} = \mathbb{E}_{x_0, \sigma, \epsilon} \left[ \max\left(0, m + \frac{\langle F(\hat{x}_0), f_{\text{neg}} \rangle}{\|F(\hat{x}_0)\|_2 \|f_{\text{neg}}\|_2} - \frac{\langle F(\hat{x}_0), F(x_0) \rangle}{\|F(\hat{x}_0)\|_2 \|F(x_0)\|_2}\right) \right],
\end{equation}
其中 $\hat{x}_0 = f_\theta(x_0 + \sigma \epsilon, y, \sigma)$ 为生成样本，$m \in [0.3, 0.5]$ 为角度裕度，$f_{\text{neg}}$ 为从训练集采样的负样本特征。

**关键改进点**：
- ✅ 直接优化角度分离，与 ArcFace 的单位超球面设计一致
- ✅ 显式拉开生成特征与负样本的距离
- ✅ 梯度信号强，收敛速度快

\subsubsection{改进的 Sigmoid 权重调度}

替换线性调度为更平滑的 Sigmoid 过度：
\begin{equation}\label{eq:tia_lambda_sigmoid}
  \lambda(t) = \frac{\lambda_{\max}}{1 + \exp(-k \cdot (t - t_{\text{mid}}) / t_{\text{total}})}
\end{equation}
其中 $k \in [5, 10]$ 控制过度的陡峭程度，$t_{\text{mid}}$ 为过度中点。

**优势**：避免线性调度的尖锐跳变，使权重变化更加平稳。

\subsubsection{综合方案 A 的总损失}

\begin{equation}\label{eq:tia_total_scheme_a}
    \mathcal{L}^{(\text{A})} = \mathcal{L}_{\text{pixel}} + \lambda(t) \cdot \mathcal{L}_{\text{feat}}^{(\text{A})}.
\end{equation}

**预期改进**：+4-5% 成功率（最高收益）

---

\subsection{方案 B：多任务学习框架}
\label{subsec:tia_scheme_b}

**核心思想**：将像素损失和特征损失视为两个相关任务，通过任务不确定性自动平衡权重。

\subsubsection{任务不确定性加权}

用任务不确定性参数替代手动权重：
\begin{equation}\label{eq:tia_uncertainty_weighting}
    \mathcal{L}^{(\text{B})} = \frac{1}{2\sigma_p^2} \mathcal{L}_{\text{pixel}} + \frac{1}{2}\log\sigma_p^2 + \frac{1}{2\sigma_f^2} \mathcal{L}_{\text{feat}} + \frac{1}{2}\log\sigma_f^2,
\end{equation}
其中 $\sigma_p$ 和 $\sigma_f$ 为可学习的任务不确定性参数，与其他网络参数联合优化。

**优势**：
- ✅ 消除手动权重调优的复杂性
- ✅ 自动学习两个任务的相对重要性
- ✅ $\sigma_i$ 小的任务自动获得更大的权重

\subsubsection{超参数配置}

推荐参数设置：
- 初始 $\log\sigma_p = 0$，$\log\sigma_f = 0$
- 学习率：$\text{lr}(\sigma) = 0.1 \times \text{lr}_{\text{main}}$（防止过度衰减）
- 训练步数：与方案 A 相同

**预期改进**：+2-3% 成功率（基于方案 A 的额外改进）

---

\subsection{方案 C：一致性正则化}
\label{subsec:tia_scheme_c}

**核心思想**：在特征空间显式约束生成结果的多样性，防止特征坍缺。

\subsubsection{类内一致性与多样性约束}

为生成对象 $\hat{x}_i, \hat{x}_j$ 在同一类内添加约束：
\begin{equation}\label{eq:tia_consistency_loss}
    \mathcal{L}_{\text{consist}}^{(\text{C})} = \frac{1}{2B^2} \sum_{i \neq j} \left( 1 - \frac{\langle F(\hat{x}_i), F(\hat{x}_j) \rangle}{\|F(\hat{x}_i)\|_2 \|F(\hat{x}_j)\|_2} \right),
\end{equation}
其中 $B$ 为批大小，目标是最大化类内特征的多样性（让生成结果有合理的差异，而不是都生成同一张脸）。

\subsubsection{综合方案 C 的总损失}

\begin{equation}\label{eq:tia_total_scheme_c}
    \mathcal{L}^{(\text{C})} = \mathcal{L}_{\text{pixel}} + \lambda(t) \cdot \mathcal{L}_{\text{feat}}^{(\text{A})} + \beta \cdot \mathcal{L}_{\text{consist}}^{(\text{C})},
\end{equation}
其中 $\beta \in [0.05, 0.15]$ 为一致性约束的权重。

**预期改进**：+1-2% 成功率（基于前两个方案）

---

\subsection{超参数参考表}

为便于实现与对比实验，表 \ref{tab:tia_hyperparams} 给出了三个方案的推荐超参数值。

\begin{table}[h]
\centering
\caption{第3章三个改进方案的超参数推荐值}
\label{tab:tia_hyperparams}
\begin{tabular}{cccccc}
\hline
方案 & 关键参数 & 推荐值 & 范围 & 含义 & 调整建议 \\
\hline
基础 & $\lambda_{\max}$ & 1.0 & [0.5, 2.0] & 特征权重 & 按验证集调整 \\
     & $t_{\text{warmup}}$ & 1000 & [500, 2000] & 预热步数 & 用于稳定早期训练 \\
\hline
A & margin $m$ & 0.35 & [0.3, 0.5] & 角度裕度 & 影响分离程度 \\
  & $k$ (Sigmoid) & 8 & [5, 10] & 过度陡峭度 & 越大越陡峭 \\
\hline
B & $\text{lr}(\sigma)$ & $0.1 \times \text{lr}_{\text{main}}$ & $[0.05, 0.2]$ & 不确定性学习率 & 关键！防止过度衰减 \\
\hline
C & $\beta$ & 0.1 & [0.05, 0.15] & 一致性权重 & 平衡多样性 \\
\hline
\end{tabular}
\end{table}

\section{训练与推理流程}[Training and Inference Procedure]
\label{sec:tia_training_inference}

\subsection{训练流程}

基于上述损失函数，模板逆向攻击模型的训练流程如算法\ref{alg:edm_tia_train}所示。训练过程采用标准的随机梯度下降优化，每次迭代从训练集中随机采样一批数据，生成带噪样本，计算混合损失并更新模型参数。

\begin{algorithm}[H]
  \caption{模板逆向攻击模型训练}
  \label{alg:edm_tia_train}
  \begin{algorithmic}[1]
    \REQUIRE 训练样本集 $\mathcal{D} = \{(x_i, y_i)\}_{i=1}^N$，扩散生成模型 $f_\theta$，特征提取网络 $F$，学习率 $\eta$，批大小 $B$
    \ENSURE 训练后的生成模型参数 $\theta$
    \STATE 初始化模型参数 $\theta$
    \FOR{训练步数 $t = 1$ 到 $T_{\text{max}}$}
    \STATE 从 $\mathcal{D}$ 中随机采样批数据 $\{(x_0^{(j)}, y^{(j)})\}_{j=1}^B$
    \FOR{批内样本 $j = 1$ 到 $B$}
    \STATE 采样噪声水平 $\sigma^{(j)} \sim p_{\sigma}$（如对数均匀分布）
    \STATE 采样标准噪声 $\epsilon^{(j)} \sim \mathcal{N}(0, I)$
    \STATE 构造带噪输入 $x_t^{(j)} = x_0^{(j)} + \sigma^{(j)} \epsilon^{(j)}$
    \STATE 通过去噪网络预测清晰图像 $\hat{x}_0^{(j)} = f_\theta(x_t^{(j)}, y^{(j)}, \sigma^{(j)})$
    \STATE 计算像素损失 $\ell_{\text{pixel}}^{(j)} = w(\sigma^{(j)}) \| \hat{x}_0^{(j)} - x_0^{(j)} \|^2$
    \STATE 计算特征损失 $\ell_{\text{feat}}^{(j)} = \| F(\hat{x}_0^{(j)}) - F(x_0^{(j)}) \|^2$
    \ENDFOR
    \STATE 计算批平均损失 $\mathcal{L}(\theta) = \frac{1}{B} \sum_{j=1}^B \left[ \ell_{\text{pixel}}^{(j)} + \lambda(t) \cdot \ell_{\text{feat}}^{(j)} \right]$
    \STATE 计算梯度 $g = \nabla_\theta \mathcal{L}(\theta)$
    \STATE 更新参数 $\theta \leftarrow \theta - \eta \cdot g$
    \ENDFOR
    \RETURN $\theta$
  \end{algorithmic}
\end{algorithm}

在实际训练中，噪声水平 $\sigma$ 通常从对数均匀分布中采样，例如 $\log \sigma \sim \mathcal{U}(\log \sigma_{\min}, \log \sigma_{\max})$。这种采样策略确保模型在不同噪声尺度下都能得到充分训练。

\subsection{推理流程}

模型训练完成后，即可用于从目标模板重建人脸图像。推理阶段的核心是求解条件扩散过程的逆向随机微分方程（reverse SDE），从纯噪声逐步去噪至清晰图像。

\subsubsection{基础采样过程}

EDM采用确定性的ODE求解器进行采样，其离散化形式为：
\[
  x_{i-1} = x_i + (\sigma_{i-1} - \sigma_i) \cdot \frac{f_\theta(x_i, y, \sigma_i) - x_i}{\sigma_i},
\]
其中 $\{\sigma_N > \sigma_{N-1} > \cdots > \sigma_0\}$ 为预设的噪声调度序列，$N$ 为采样步数。初始状态 $x_N$ 从标准正态分布采样，即 $x_N \sim \mathcal{N}(0, \sigma_N^2 I)$。条件信息 $y$ 可以是身份标签或目标特征模板。

\subsubsection{模板条件引导}

为增强生成图像与目标模板的匹配度，在采样过程中引入梯度引导机制。具体而言，在每个去噪步骤中，除了沿着学习到的分数函数方向更新外，还额外施加一个朝向目标模板的梯度项：
\[
  x_{i-1} = x_i + (\sigma_{i-1} - \sigma_i) \cdot \left[ \frac{f_\theta(x_i, y, \sigma_i) - x_i}{\sigma_i} + \alpha \cdot \nabla_{x_i} \mathrm{sim}(F(x_i), t) \right],
\]
其中 $t \in \mathbb{R}^d$ 为目标特征模板，$\alpha$ 为引导强度超参数，$\mathrm{sim}(\cdot, \cdot)$ 为相似度函数（如余弦相似度）。引导梯度通过反向传播计算：
\[
  \nabla_{x_i} \mathrm{sim}(F(x_i), t) = \nabla_{x_i} \left[ \frac{F(x_i) \cdot t}{\|F(x_i)\|_2 \|t\|_2} \right].
\]

引导强度 $\alpha$ 的选择需要权衡生成质量与模板匹配度。较大的 $\alpha$ 能够提升特征相似度，但可能导致图像失真；较小的 $\alpha$ 则保持较好的视觉质量，但匹配度可能不足。

\subsubsection{完整推理算法}

完整的模板条件推理流程如算法\ref{alg:edm_tia_infer}所示。

\begin{algorithm}[H]
  \caption{基于目标模板的推理重建}
  \label{alg:edm_tia_infer}
  \begin{algorithmic}[1]
    \REQUIRE 目标模板 $t \in \mathbb{R}^d$，训练好的去噪网络 $f_\theta$，特征提取器 $F$，噪声调度 $\{\sigma_i\}_{i=0}^N$，引导强度 $\alpha$
    \ENSURE 重建图像 $\hat{x}_0$
    \STATE 从标准正态分布采样初始噪声 $x_N \sim \mathcal{N}(0, \sigma_N^2 I)$
    \FOR{$i = N$ 到 $1$}
    \STATE 通过去噪网络预测 $\hat{x}_0^{(i)} = f_\theta(x_i, t, \sigma_i)$
    \STATE 计算基础更新方向 $d_{\text{base}} = \frac{\hat{x}_0^{(i)} - x_i}{\sigma_i}$
    \STATE 计算特征相似度 $s = \mathrm{sim}(F(x_i), t)$
    \STATE 计算引导梯度 $g = \nabla_{x_i} s$
    \STATE 合成更新方向 $d = d_{\text{base}} + \alpha \cdot g$
    \STATE 更新状态 $x_{i-1} = x_i + (\sigma_{i-1} - \sigma_i) \cdot d$
    \STATE 可选：对 $x_{i-1}$ 进行像素值裁剪，确保在有效范围内
    \ENDFOR
    \STATE 最终输出 $\hat{x}_0 = x_0$
    \RETURN $\hat{x}_0$
  \end{algorithmic}
\end{algorithm}

图\ref{fig:edm_tia_infer}直观展示了从随机噪声到重建图像的完整推理过程，其中每一步都在去噪方向与特征引导方向的联合作用下逐步逼近目标。

\begin{figure}[!htbp]
  \centering
  \includegraphics[width=0.8\textwidth]{images/infer.drawio.pdf}
  \caption{基于EDM的模板逆向攻击模型推理流程示意图。从纯噪声 $x_N$ 出发，通过 $N$ 步迭代去噪，每步结合去噪网络预测与特征引导梯度，最终生成与目标模板匹配的人脸图像 $\hat{x}_0$。}
  \label{fig:edm_tia_infer}
\end{figure}

\section{方法优势与适用性分析}[Method Advantages and Applicability Analysis]
\label{sec:tia_advantages}

相较于传统的基于优化的逆向重建方法（如直接在像素空间进行梯度优化），本章提出的基于扩散模型的方法具有以下优势：
（1）生成质量高：扩散模型通过学习数据分布的先验知识，能够生成符合自然人脸的高质量图像，避免了直接优化方法常见的伪影和非自然纹理问题。
（2）收敛稳定：训练过程采用标准的回归目标，无需对抗训练，避免了生成对抗网络形式模型的模式崩塌和训练不稳定问题。
（3）灵活性强：通过调整引导强度 $\alpha$ 和采样步数 $N$，可以灵活平衡生成速度、视觉质量与特征匹配度，适应不同的攻击场景需求。
（4）可扩展性好：方法框架具有良好的可扩展性，可以方便地引入其他约束（如属性控制、多模板融合等）或替换为不同的扩散模型变体。

该方法适用于攻击者已知特征提取器结构与权重的白盒攻击场景。在黑盒场景下，可以使用替代模型或迁移攻击策略。此外，方法对训练数据的分布有一定依赖，当目标模板来自训练分布外的人群（如特殊族裔、极端年龄段等）时，重建质量可能下降，需要通过数据增强或领域适应技术加以改善。

\section{本章小结}[Summary]

本章针对人脸识别系统中基于模板匹配的验证机制，系统研究了面向人脸特征提取模型的逆向重建方法。通过对模板信息逆向重建为可感知图像的技术路径进行深入探讨，本章为后续章节的实验验证奠定了理论与方法论基础。

首先，本章对攻击任务与假设进行了形式化表述，明确定义了原始图像空间、识别器映射以及目标模板的数学形式，并给出了基于余弦相似度的验证机制。在此基础上，将攻击者的目标形式化为一个优化问题，即最大化重构图像与目标模板在特征空间中的相似度，为攻击成功判据提供了清晰的数学刻画。这一形式化框架不仅有助于理解模板逆向重建的本质，也为后续方法的设计与评估提供了统一的理论基础。

其次，本章提出了一种基于明晰扩散模型的模板逆向重建方法。该方法的核心创新在于将扩散生成模型的去噪过程与人脸识别的特征匹配目标相结合，通过设计包含像素空间重建损失与特征空间感知损失的混合目标函数，实现了视觉质量与识别一致性的双重优化。为平衡这两项损失的作用，本章采用了动态调整策略，在训练过程中逐步增强特征空间约束的权重，使模型在学习基础图像结构的同时，能够有效捕获目标模板的特征信息。此外，本章还详细阐述了训练与推理的完整流程，并通过算法伪码与流程图对关键步骤进行了可视化说明，为方法的实现与复现提供了清晰的指导。

综上所述，本章通过形式化的问题建模与基于扩散模型的方法设计，为面向人脸特征提取模型的逆向重建提供了系统的解决方案。该方法不仅在理论层面揭示了模板信息与图像空间之间的映射关系，也在工程层面展示了如何利用现代生成模型技术实现高质量的模板逆向重建。本章所提出的方法框架与评估标准，将为第五章的实验研究与性能分析提供重要的理论支撑与方法指导。
